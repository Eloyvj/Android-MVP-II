package com.example.moviesmvp

import com.example.moviesmvp.features.data.mapper.MovieMapper
import com.example.moviesmvp.features.data.network.response.MovieResponse
import com.example.moviesmvp.features.interactor.PopularMoviesInteractor
import com.example.moviesmvp.features.popularmovieslist.PopularMoviesFragmentPresenterImpl
import com.example.moviesmvp.features.popularmovieslist.PopularMoviesPresenter
import com.example.moviesmvp.features.popularmovieslist.PopularMoviesView
import com.example.moviesmvp.util.TestSchedulersProvider
import com.example.moviesmvp.util.loadJson
import com.nhaarman.mockitokotlin2.mock
import com.nhaarman.mockitokotlin2.verify
import com.nhaarman.mockitokotlin2.whenever
import io.reactivex.Observable
import io.reactivex.schedulers.TestScheduler
import org.junit.Test
import org.junit.runner.RunWith
import org.junit.runners.JUnit4
import org.mockito.Mockito

@RunWith(JUnit4::class)
class PopularMoviesListTest {

    val view: PopularMoviesView = mock()

    val interactor: PopularMoviesInteractor = mock()

    var presenter: PopularMoviesPresenter

    val mapper = MovieMapper()

    private var testScheduler: TestScheduler

    init {
        testScheduler = TestScheduler()
        val testSchedulerProvider = TestSchedulersProvider(testScheduler)
        presenter = PopularMoviesFragmentPresenterImpl(view, testSchedulerProvider, interactor)
    }

    @Test
    fun `send popular movies list for adapter after fetch from api`() {
        val list = mapper.fromResponseToMovieDomain(mockPopularMoviesList())
        whenever(interactor.fetchPopularMovies(1)).thenReturn(Observable.just(list))

        presenter.loadItems()

        testScheduler.triggerActions()

        verify(view, Mockito.times(1)).setUpListForAdapter(list)
    }

    private fun mockPopularMoviesList(): List<MovieResponse> {
        return loadJson("[\n  {\n    \"popularity\": 259.91,\n    \"vote_count\": 366,\n    \"video\": false,\n    \"poster_path\": \"/aQvJ5WPzZgYVDrxLX4R6cLJCEaQ.jpg\",\n    \"id\": 454626,\n    \"adult\": false,\n    \"backdrop_path\": \"/qonBhlm0UjuKX2sH7e73pnG0454.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Sonic the Hedgehog\",\n    \"genre_ids\": [\n      28,\n      35,\n      878,\n      10751\n    ],\n    \"title\": \"Sonic the Hedgehog\",\n    \"vote_average\": 7.1,\n    \"overview\": \"Based on the global blockbuster videogame franchise from Sega, Sonic the Hedgehog tells the story of the world’s speediest hedgehog as he embraces his new home on Earth. In this live-action adventure comedy, Sonic and his new best friend team up to defend the planet from the evil genius Dr. Robotnik and his plans for world domination.\",\n    \"release_date\": \"2020-02-12\"\n  },\n  {\n    \"popularity\": 253.357,\n    \"vote_count\": 4333,\n    \"video\": false,\n    \"poster_path\": \"/7IiTTgloJzvGI1TAYymCfbfl3vT.jpg\",\n    \"id\": 496243,\n    \"adult\": false,\n    \"backdrop_path\": \"/TU9NIjwzjoKPwQHoHshkFcQUCG.jpg\",\n    \"original_language\": \"ko\",\n    \"original_title\": \"기생충\",\n    \"genre_ids\": [\n      35,\n      18,\n      53\n    ],\n    \"title\": \"Parasite\",\n    \"vote_average\": 8.6,\n    \"overview\": \"All unemployed, Ki-taek's family takes peculiar interest in the wealthy and glamorous Parks for their livelihood until they get entangled in an unexpected incident.\",\n    \"release_date\": \"2019-05-30\"\n  },\n  {\n    \"popularity\": 213.161,\n    \"vote_count\": 2415,\n    \"video\": false,\n    \"poster_path\": \"/xBHvZcjRiWyobQ9kxBhO6B2dtRI.jpg\",\n    \"id\": 419704,\n    \"adult\": false,\n    \"backdrop_path\": \"/5BwqwxMEjeFtdknRV792Svo0K1v.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Ad Astra\",\n    \"genre_ids\": [\n      12,\n      18,\n      9648,\n      878,\n      53\n    ],\n    \"title\": \"Ad Astra\",\n    \"vote_average\": 6,\n    \"overview\": \"The near future, a time when both hope and hardships drive humanity to look to the stars and beyond. While a mysterious phenomenon menaces to destroy life on planet Earth, astronaut Roy McBride undertakes a mission across the immensity of space and its many perils to uncover the truth about a lost expedition that decades before boldly faced emptiness and silence in search of the unknown.\",\n    \"release_date\": \"2019-09-17\"\n  },\n  {\n    \"popularity\": 171.658,\n    \"vote_count\": 776,\n    \"video\": false,\n    \"poster_path\": \"/h4VB6m0RwcicVEZvzftYZyKXs6K.jpg\",\n    \"id\": 495764,\n    \"adult\": false,\n    \"backdrop_path\": \"/uozb2VeD87YmhoUP1RrGWfzuCrr.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Birds of Prey (and the Fantabulous Emancipation of One Harley Quinn)\",\n    \"genre_ids\": [\n      28,\n      35,\n      80\n    ],\n    \"title\": \"Birds of Prey (and the Fantabulous Emancipation of One Harley Quinn)\",\n    \"vote_average\": 6.8,\n    \"overview\": \"After her breakup with the Joker, Harley Quinn joins forces with singer Black Canary, assassin Huntress, and police detective Renee Montoya to help a young girl named Cassandra, who had a hit placed on her after she stole a rare diamond from crime lord Roman Sionis.\",\n    \"release_date\": \"2020-02-05\"\n  },\n  {\n    \"popularity\": 154.297,\n    \"vote_count\": 2258,\n    \"video\": false,\n    \"poster_path\": \"/pThyQovXQrw2m0s9x82twj48Jq4.jpg\",\n    \"id\": 546554,\n    \"adult\": false,\n    \"backdrop_path\": \"/cjTQSwcsfVdirSFSHNBXRGkxmWa.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Knives Out\",\n    \"genre_ids\": [\n      35,\n      80,\n      18,\n      9648,\n      53\n    ],\n    \"title\": \"Knives Out\",\n    \"vote_average\": 7.8,\n    \"overview\": \"When renowned crime novelist Harlan Thrombey is found dead at his estate just after his 85th birthday, the inquisitive and debonair Detective Benoit Blanc is mysteriously enlisted to investigate. From Harlan's dysfunctional family to his devoted staff, Blanc sifts through a web of red herrings and self-serving lies to uncover the truth behind Harlan's untimely death.\",\n    \"release_date\": \"2019-11-27\"\n  },\n  {\n    \"popularity\": 153.527,\n    \"vote_count\": 1959,\n    \"video\": false,\n    \"poster_path\": \"/49HMMZPVJcnUwe2QmVzBfxyLAY2.jpg\",\n    \"id\": 258216,\n    \"adult\": false,\n    \"backdrop_path\": \"/t9MElpSTsqNBttwntdevOgQuJDe.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Nymphomaniac: Vol. I\",\n    \"genre_ids\": [\n      18\n    ],\n    \"title\": \"Nymphomaniac: Vol. I\",\n    \"vote_average\": 6.9,\n    \"overview\": \"A man named Seligman finds a fainted wounded woman in an alley and he brings her home. She tells him that her name is Joe and that she is nymphomaniac. Joe tells her life and sexual experiences with hundreds of men since she was a young teenager while Seligman tells about his hobbies, such as fly fishing, reading about Fibonacci numbers or listening to organ music.\",\n    \"release_date\": \"2013-12-25\"\n  },\n  {\n    \"popularity\": 144.386,\n    \"vote_count\": 2423,\n    \"video\": false,\n    \"poster_path\": \"/h6Wi81XNXCjTAcdstiCLRykN3Pa.jpg\",\n    \"id\": 330457,\n    \"adult\": false,\n    \"backdrop_path\": \"/xJWPZIYOEFIjZpBL7SVBGnzRYXp.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Frozen II\",\n    \"genre_ids\": [\n      12,\n      16,\n      10751\n    ],\n    \"title\": \"Frozen II\",\n    \"vote_average\": 7,\n    \"overview\": \"Elsa, Anna, Kristoff and Olaf head far into the forest to learn the truth about an ancient mystery of their kingdom.\",\n    \"release_date\": \"2019-11-20\"\n  },\n  {\n    \"popularity\": 135.64,\n    \"vote_count\": 43,\n    \"video\": false,\n    \"poster_path\": \"/33VdppGbeNxICrFUtW2WpGHvfYc.jpg\",\n    \"id\": 481848,\n    \"adult\": false,\n    \"backdrop_path\": \"/yFRpUmsreYO5Bc0HVBTsJsHIIox.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"The Call of the Wild\",\n    \"genre_ids\": [\n      12,\n      18,\n      10751\n    ],\n    \"title\": \"The Call of the Wild\",\n    \"vote_average\": 6.3,\n    \"overview\": \"A sled dog struggles for survival in the wilds of the Yukon.\",\n    \"release_date\": \"2020-02-19\"\n  },\n  {\n    \"popularity\": 131.369,\n    \"vote_count\": 9294,\n    \"video\": false,\n    \"poster_path\": \"/udDclJoHjfjb8Ekgsd4FDteOkCU.jpg\",\n    \"id\": 475557,\n    \"adult\": false,\n    \"backdrop_path\": \"/n6bUvigpRFqSwmPp1m2YADdbRBc.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Joker\",\n    \"genre_ids\": [\n      80,\n      18,\n      53\n    ],\n    \"title\": \"Joker\",\n    \"vote_average\": 8.2,\n    \"overview\": \"During the 1980s, a failed stand-up comedian is driven insane and turns to a life of crime and chaos in Gotham City while becoming an infamous psychopathic crime figure.\",\n    \"release_date\": \"2019-10-02\"\n  },\n  {\n    \"popularity\": 123.661,\n    \"vote_count\": 439,\n    \"video\": false,\n    \"poster_path\": \"/5eNiYMu2GXCtNlDwMcJqKGVwyoX.jpg\",\n    \"id\": 448119,\n    \"adult\": false,\n    \"backdrop_path\": \"/lG802rseTZcN9mtLsQPVfApEVzM.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Dolittle\",\n    \"genre_ids\": [\n      12,\n      35,\n      14,\n      10751\n    ],\n    \"title\": \"Dolittle\",\n    \"vote_average\": 6.4,\n    \"overview\": \"After losing his wife seven years earlier, the eccentric Dr. John Dolittle, famed doctor and veterinarian of Queen Victoria’s England, hermits himself away behind the high walls of Dolittle Manor with only his menagerie of exotic animals for company. But when the young queen falls gravely ill, a reluctant Dolittle is forced to set sail on an epic adventure to a mythical island in search of a cure, regaining his wit and courage as he crosses old adversaries and discovers wondrous creatures.\",\n    \"release_date\": \"2020-01-01\"\n  },\n  {\n    \"popularity\": 116.081,\n    \"vote_count\": 1610,\n    \"video\": false,\n    \"poster_path\": \"/jyw8VKYEiM1UDzPB7NsisUgBeJ8.jpg\",\n    \"id\": 512200,\n    \"adult\": false,\n    \"backdrop_path\": \"/zTxHf9iIOCqRbxvl8W5QYKrsMLq.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Jumanji: The Next Level\",\n    \"genre_ids\": [\n      28,\n      12,\n      35,\n      14\n    ],\n    \"title\": \"Jumanji: The Next Level\",\n    \"vote_average\": 6.7,\n    \"overview\": \"As the gang return to Jumanji to rescue one of their own, they discover that nothing is as they expect. The players will have to brave parts unknown and unexplored in order to escape the world’s most dangerous game.\",\n    \"release_date\": \"2019-12-04\"\n  },\n  {\n    \"popularity\": 109.164,\n    \"vote_count\": 1505,\n    \"video\": false,\n    \"poster_path\": \"/vqzNJRH4YyquRiWxCCOH0aXggHI.jpg\",\n    \"id\": 290859,\n    \"adult\": false,\n    \"backdrop_path\": \"/riTANvQ8GKmQbgtC1ps3OfkU43A.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Terminator: Dark Fate\",\n    \"genre_ids\": [\n      28,\n      878\n    ],\n    \"title\": \"Terminator: Dark Fate\",\n    \"vote_average\": 6.2,\n    \"overview\": \"Decades after Sarah Connor prevented Judgment Day, a lethal new Terminator is sent to eliminate the future leader of the resistance. In a fight to save mankind, battle-hardened Sarah Connor teams up with an unexpected ally and an enhanced super soldier to stop the deadliest Terminator yet.\",\n    \"release_date\": \"2019-10-23\"\n  },\n  {\n    \"popularity\": 106.796,\n    \"vote_count\": 889,\n    \"video\": false,\n    \"poster_path\": \"/y95lQLnuNKdPAzw9F9Ab8kJ80c3.jpg\",\n    \"id\": 38700,\n    \"adult\": false,\n    \"backdrop_path\": \"/upUy2QhMZEmtypPW3PdieKLAHxh.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Bad Boys for Life\",\n    \"genre_ids\": [\n      28,\n      80,\n      53\n    ],\n    \"title\": \"Bad Boys for Life\",\n    \"vote_average\": 6.4,\n    \"overview\": \"Marcus and Mike are forced to confront new threats, career changes, and midlife crises as they join the newly created elite team AMMO of the Miami police department to take down the ruthless Armando Armas, the vicious leader of a Miami drug cartel.\",\n    \"release_date\": \"2020-01-15\"\n  },\n  {\n    \"popularity\": 101.836,\n    \"vote_count\": 2771,\n    \"video\": false,\n    \"poster_path\": \"/AuGiPiGMYMkSosOJ3BQjDEAiwtO.jpg\",\n    \"id\": 530915,\n    \"adult\": false,\n    \"backdrop_path\": \"/cqa3sa4c4jevgnEJwq3CMF8UfTG.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"1917\",\n    \"genre_ids\": [\n      28,\n      18,\n      10752\n    ],\n    \"title\": \"1917\",\n    \"vote_average\": 8,\n    \"overview\": \"At the height of the First World War, two young British soldiers must cross enemy territory and deliver a message that will stop a deadly attack on hundreds of soldiers.\",\n    \"release_date\": \"2019-12-10\"\n  },\n  {\n    \"popularity\": 98.376,\n    \"vote_count\": 1624,\n    \"video\": false,\n    \"poster_path\": \"/6ApDtO7xaWAfPqfi2IARXIzj8QS.jpg\",\n    \"id\": 359724,\n    \"adult\": false,\n    \"backdrop_path\": \"/n3UanIvmnBlH531pykuzNs4LbH6.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Ford v Ferrari\",\n    \"genre_ids\": [\n      28,\n      18\n    ],\n    \"title\": \"Ford v Ferrari\",\n    \"vote_average\": 7.8,\n    \"overview\": \"American car designer Carroll Shelby and the British-born driver Ken Miles work together to battle corporate interference, the laws of physics, and their own personal demons to build a revolutionary race car for Ford Motor Company and take on the dominating race cars of Enzo Ferrari at the 24 Hours of Le Mans in France in 1966.\",\n    \"release_date\": \"2019-11-13\"\n  },\n  {\n    \"popularity\": 97.524,\n    \"vote_count\": 108,\n    \"video\": false,\n    \"poster_path\": \"/hJ6YEbrjFvToa5c7IiUqILoB6Je.jpg\",\n    \"id\": 552178,\n    \"adult\": false,\n    \"backdrop_path\": \"/4ZSlTfkHtgTTupCaLbseXQQzZha.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Dark Waters\",\n    \"genre_ids\": [\n      18\n    ],\n    \"title\": \"Dark Waters\",\n    \"vote_average\": 7.4,\n    \"overview\": \"A tenacious attorney uncovers a dark secret that connects a growing number of unexplained deaths due to one of the world's largest corporations. In the process, he risks everything — his future, his family, and his own life — to expose the truth.\",\n    \"release_date\": \"2019-11-22\"\n  },\n  {\n    \"popularity\": 97.504,\n    \"vote_count\": 8726,\n    \"video\": false,\n    \"poster_path\": \"/jpfkzbIXgKZqCZAkEkFH2VYF63s.jpg\",\n    \"id\": 920,\n    \"adult\": false,\n    \"backdrop_path\": \"/a1MlbLBk5Sy6YvMbSuKfwGlDVlb.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Cars\",\n    \"genre_ids\": [\n      12,\n      16,\n      35,\n      10751\n    ],\n    \"title\": \"Cars\",\n    \"vote_average\": 6.7,\n    \"overview\": \"Lightning McQueen, a hotshot rookie race car driven to succeed, discovers that life is about the journey, not the finish line, when he finds himself unexpectedly detoured in the sleepy Route 66 town of Radiator Springs. On route across the country to the big Piston Cup Championship in California to compete against two seasoned pros, McQueen gets to know the town's offbeat characters.\",\n    \"release_date\": \"2006-06-08\"\n  },\n  {\n    \"popularity\": 96.786,\n    \"vote_count\": 2015,\n    \"video\": false,\n    \"poster_path\": \"/7GsM4mtM0worCtIVeiQt28HieeN.jpg\",\n    \"id\": 515001,\n    \"adult\": false,\n    \"backdrop_path\": \"/agoBZfL1q5G79SD0npArSlJn8BH.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Jojo Rabbit\",\n    \"genre_ids\": [\n      35,\n      18,\n      10752\n    ],\n    \"title\": \"Jojo Rabbit\",\n    \"vote_average\": 8.1,\n    \"overview\": \"A World War II satire that follows a lonely German boy whose world view is turned upside down when he discovers his single mother is hiding a young Jewish girl in their attic. Aided only by his idiotic imaginary friend, Adolf Hitler, Jojo must confront his blind nationalism.\",\n    \"release_date\": \"2019-10-18\"\n  },\n  {\n    \"popularity\": 95.081,\n    \"vote_count\": 558,\n    \"video\": false,\n    \"poster_path\": \"/uPGq1mkEXznUpapDmOSxbsybjfp.jpg\",\n    \"id\": 475303,\n    \"adult\": false,\n    \"backdrop_path\": \"/6fkqwqLEcDZOEAnBBfKAniwNxtx.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"A Rainy Day in New York\",\n    \"genre_ids\": [\n      35,\n      10749\n    ],\n    \"title\": \"A Rainy Day in New York\",\n    \"vote_average\": 6.8,\n    \"overview\": \"Two young people arrive in New York to spend a weekend, but once they arrive they're met with bad weather and a series of adventures.\",\n    \"release_date\": \"2019-07-26\"\n  },\n  {\n    \"popularity\": 93.625,\n    \"vote_count\": 356,\n    \"video\": false,\n    \"poster_path\": \"/hj8pyoNnynGeJTAbl7jcLZO8Uhx.jpg\",\n    \"id\": 522162,\n    \"adult\": false,\n    \"backdrop_path\": \"/xjP88DFPCQ81mbZHXFscyYtGskT.jpg\",\n    \"original_language\": \"en\",\n    \"original_title\": \"Midway\",\n    \"genre_ids\": [\n      28,\n      18,\n      36,\n      10752\n    ],\n    \"title\": \"Midway\",\n    \"vote_average\": 6.7,\n    \"overview\": \"The story of the Battle of Midway, and the leaders and soldiers who used their instincts, fortitude and bravery to overcome massive odds.\",\n    \"release_date\": \"2019-11-06\"\n  }\n]\n")
    }
}
